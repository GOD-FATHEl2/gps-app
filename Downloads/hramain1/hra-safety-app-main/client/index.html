<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <title>Högriskarbete – Riskbedömning</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
<header>
  <div class="header-content">
    <h1>Bedömning av högriskarbete</h1>
    <button id="mobileMenuToggle" class="mobile-menu-toggle" aria-label="Toggle menu">
      <span class="hamburger"></span>
      <span class="hamburger"></span>
      <span class="hamburger"></span>
    </button>
  </div>
  <nav id="nav" class="hidden">
    <button data-view="form">Ny bedömning</button>
    <button data-view="mine">Mina</button>
    <button data-view="dash" class="role-sup hidden">Dashboard</button>
    <button data-view="users" class="role-admin hidden">Användare</button>
    <button onclick="window.open('information.html', '_blank')">ℹ️ Info</button>
    <button id="logout" class="right">Logga ut</button>
  </nav>
</header>

<main>
  <!-- LOGIN -->
  <!-- LOGIN -->
<section id="loginView" class="card login-card">
  <div class="login-header">
    <h2 class="neon-glow">Logga in</h2>
    <p class="login-subtitle">Välj inloggningssätt nedan</p>
  </div>

  <!-- Sign-in options -->
  <div class="login-options">
    <!-- MSAL Authentication Option -->
    <button id="msalLoginBtn" class="msal-login-btn login-option">
      <span class="microsoft-icon">🏢</span>
      Logga in med Microsoft
    </button>

    <div id="networkStatus" class="network-status hidden">
      <small>🌐 Nätverksstatus: <span id="networkStatusText">Testar...</span></small>
    </div>

    <!-- Divider -->
    <div class="divider login-divider"><span>eller</span></div>

    <!-- Password login toggle -->
    <button id="togglePwdLoginBtn" class="toggle-pwd-btn" aria-expanded="false" aria-controls="passwordLogin">
      <span class="chev">▸</span>
      Logga in med lösenord
    </button>

    <!-- Traditional Login (collapsible) -->
    <div id="passwordLogin" class="collapsible">
      <div class="login-form">
        <label>
          Användarnamn
          <div class="input-with-icon">
            <input id="lu" autocomplete="username" placeholder="Ex: namn.efternamn"/>
            <span class="input-icon">👤</span>
          </div>
        </label>

        <label>
          Lösenord
          <div class="input-with-icon">
            <input id="lp" type="password" autocomplete="current-password" placeholder="••••••••"/>
            <button type="button" class="pwd-toggle" aria-label="Visa/dölj lösenord">👁️</button>
          </div>
        </label>

        <div class="login-row">
          <label class="remember">
            <input id="rememberMe" type="checkbox"/>
            Kom ihåg mig
          </label>
          <a class="forgot" href="#" onclick="return false;">Glömt lösenord?</a>
        </div>

        <button id="loginBtn" class="login-submit">
          <span class="spinner" aria-hidden="true" style="display:none"></span>
          <span class="btn-text">Logga in</span>
        </button>

        <p id="loginMsg" class="warn hidden" role="alert"></p>
      </div>

      <!-- Helpful demo hints (kept, styled) -->
      <div id="testUserHints" class="test-user-hints hidden">
        <p class="hint">📝 Testa med dessa användare:</p>
        <div class="test-users">
          <div class="test-user">👤 <strong>test1</strong> / test123 <em>(admin)</em></div>
          <div class="test-user">👤 <strong>test2</strong> / test123 <em>(supervisor)</em></div>
          <div class="test-user">👤 <strong>test3</strong> / test123 <em>(underhåll)</em></div>
        </div>
      </div>
    </div>
  </div>
</section>


  <!-- FORM -->
  <section id="formView" class="card hidden"></section>

  <!-- MY LIST -->
  <section id="mineView" class="card hidden">
    <h2>Bedömningar</h2>
    <div id="mineTable"></div>
  </section>

  <!-- DASHBOARD (supervisor/superintendent/admin) -->
  <section id="dashView" class="card hidden">
    <h2>Dashboard (senaste 30 dagar)</h2>
    <div id="stats"></div>
    <button id="refreshDash">Uppdatera</button>
    <div id="allTable" style="margin-top:12px"></div>
  </section>

  <!-- USERS (admin) -->
  <section id="usersView" class="card hidden">
    <h2>Användarhantering</h2>
    <div class="grid3">
      <label>Namn<input id="u_name"></label>
      <label>Användarnamn<input id="u_user"></label>
      <label>Lösenord<input id="u_pass" type="password"></label>
      <label>Roll
        <select id="u_role">
          <option value="underhall">Underhåll</option>
          <option value="supervisor">Supervisor</option>
          <option value="superintendent">Superintendent</option>
          <option value="admin">Administrator</option>
        </select>
      </label>
      <label>Aktiv
        <select id="u_active"><option value="1">Ja</option><option value="0">Nej</option></select>
      </label>
    </div>
    <button id="addUser">Lägg till användare</button>
    <div id="usersTable" style="margin-top:12px"></div>
  </section>
</main>

<footer>
  <small> Copyright AB Volvo 2025 VCT- Volvo-TBA • </small>
</footer>

<script src="msal-diagnostics.js"></script>
<script src="msalAuthService.js"></script>
<script src="app.js"></script>
<script src="dynamic-ui.js"></script>
<script src="image-upload.js"></script>
<script src="notifications.js"></script>

<!-- Toggle logic for password login -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.getElementById('togglePwdLoginBtn');
  const pwdSection = document.getElementById('passwordLogin');
  const divider = document.getElementById('dividerOr');

  const openPwd = () => {
    pwdSection.style.display = '';
    divider.style.display = '';
    toggleBtn.setAttribute('aria-expanded', 'true');
    const user = document.getElementById('lu');
    if (user) user.focus();
  };

  const closePwd = () => {
    pwdSection.style.display = 'none';
    divider.style.display = 'none';
    toggleBtn.setAttribute('aria-expanded', 'false');
  };

  // Ensure hidden at load
  closePwd();

  toggleBtn.addEventListener('click', () => {
    const visible = pwdSection.style.display !== 'none';
    visible ? closePwd() : openPwd();
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const toggleBtn = document.getElementById('togglePwdLoginBtn');
  const collapsible = document.getElementById('passwordLogin');
  const user = document.getElementById('lu');
  const pwd = document.getElementById('lp');
  const pwdToggle = document.querySelector('.pwd-toggle');
  const loginBtn = document.getElementById('loginBtn');
  const loginMsg = document.getElementById('loginMsg');
  const spinner = loginBtn?.querySelector('.spinner');
  const btnText = loginBtn?.querySelector('.btn-text');

  // Collapsible behavior with smooth height transition
  const setOpen = (open) => {
    toggleBtn?.setAttribute('aria-expanded', String(open));
    toggleBtn?.classList.toggle('open', open);
    if (open) {
      collapsible.style.display = 'block';
      const h = collapsible.scrollHeight + 'px';
      collapsible.style.maxHeight = h;
      setTimeout(() => { collapsible.style.maxHeight = '1000px'; }, 10);
      user?.focus();
    } else {
      collapsible.style.maxHeight = collapsible.scrollHeight + 'px';
      requestAnimationFrame(() => {
        collapsible.style.maxHeight = '0';
        collapsible.addEventListener('transitionend', () => {
          if (collapsible.style.maxHeight === '0px') collapsible.style.display = 'none';
        }, { once: true });
      });
    }
  };

  // Init collapsed
  collapsible.style.display = 'none';
  collapsible.style.maxHeight = '0';

  toggleBtn?.addEventListener('click', () => {
    const open = toggleBtn.getAttribute('aria-expanded') === 'true';
    setOpen(!open);
  });

  // Password visibility toggle
  pwdToggle?.addEventListener('click', () => {
    const type = pwd.getAttribute('type') === 'password' ? 'text' : 'password';
    pwd.setAttribute('type', type);
    pwdToggle.classList.toggle('on', type === 'text');
  });

  // Enter to submit
  [user, pwd].forEach(el => {
    el?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') loginBtn?.click();
    });
  });

  // Optional: add a tiny loading state when your existing login logic runs
  // Call these from your existing login handler in app.js if you want:
  window.__loginLoading = (on) => {
    if (!loginBtn) return;
    loginBtn.disabled = !!on;
    if (spinner) spinner.style.display = on ? '' : 'none';
    if (btnText) btnText.textContent = on ? 'Loggar in...' : 'Logga in';
  };

  // Optional: shake on error when #loginMsg is shown by your existing logic
  const observer = new MutationObserver(() => {
    if (loginMsg && !loginMsg.classList.contains('hidden')) {
      collapsible.classList.add('shake');
      setTimeout(() => collapsible.classList.remove('shake'), 500);
    }
  });
  if (loginMsg) observer.observe(loginMsg, { attributes: true, attributeFilter: ['class'] });
});
</script>

</body>
</html>
